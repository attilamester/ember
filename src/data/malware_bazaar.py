import os.path

from api.malware_bazaar import MalwareBazaarAPI
from data import DatasetProvider
from model.sample import Sample


class MalwareBazaar(DatasetProvider):

    @classmethod
    def get_sample(cls, md5: str = None, sha256: str = None) -> Sample:
        expected_path = os.path.join(MalwareBazaar.get_dir_samples(), f"{sha256}.mbazaar")
        if os.path.isfile(expected_path):
            return Sample(filepath=expected_path, sha256=sha256)

        code, data, msg = MalwareBazaarAPI.download_sample(sha256=sha256, download_dir=MalwareBazaar.get_dir_samples())
        if code != 200:
            raise Exception(f"Cannot find MalwareBazaar file: {sha256}")
        return Sample(filepath=data["path"], sha256=sha256)

    @classmethod
    def get_dir_samples(cls):
        return os.environ["MBAZAAR_DIR_SAMPLES"]
